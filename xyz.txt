import os
import struct
import json

# Mapping of extensions to magic number signatures
MAGIC_SIGNATURES = {
    "npy": [b"\x93NUMPY"],
    "npz": [b"PK\x03\x04"],  # ZIP
    "pickle": [b"\x80"],
    "pt": [b"\x80"],
    "pth": [b"\x80"],
    "7z": [b"\x37\x7A\xBC\xAF\x27\x1C"],
    "json": [b"{", b"["],  # Soft match
    "msgpack": [bytes([0x80])],  # Approx â€” messagepack map prefix
}

# Extensions with no reliable magic number
NO_MAGIC_VALIDATION = {"safetensors", "bin", "model", "txt", "md"}

def detect_magic_format(file_path):
    with open(file_path, "rb") as f:
        header = f.read(16)

    for ext, signatures in MAGIC_SIGNATURES.items():
        for sig in signatures:
            if header.startswith(sig):
                return ext
    return None

def is_probably_safetensors(file_path):
    try:
        with open(file_path, "rb") as f:
            header_len = struct.unpack("<Q", f.read(8))[0]
            header_json = f.read(header_len).decode("utf-8")
            header = json.loads(header_json)
        return isinstance(header, dict) and all("shape" in v for v in header.values())
    except Exception:
        return False

def validate_file(file_path):
    claimed_ext = os.path.splitext(file_path)[1].lstrip(".").lower()

    print(f"\nðŸ” Checking: {file_path}  (Extension: .{claimed_ext})")

    if claimed_ext in NO_MAGIC_VALIDATION:
        if claimed_ext == "safetensors":
            if is_probably_safetensors(file_path):
                print("âœ… Detected valid .safetensors structure.")
            else:
                print("âŒ Invalid .safetensors file structure detected!")
        else:
            print(f"âš ï¸ File extension tampering script does NOT apply to '.{claimed_ext}' files â€” no reliable signature.")
        return

    detected_ext = detect_magic_format(file_path)

    if detected_ext is None:
        print("âŒ Unable to detect file type â€” possible corruption or unknown format.")
    elif detected_ext != claimed_ext:
        print(f"ðŸš¨ Extension mismatch: Claimed '.{claimed_ext}' but detected as '{detected_ext}'")
    else:
        print(f"âœ… File extension matches detected format: .{claimed_ext}")

def validate_directory(directory_path):
    for filename in os.listdir(directory_path):
        filepath = os.path.join(directory_path, filename)
        if os.path.isfile(filepath):
            validate_file(filepath)

# ðŸ§ª Example usage:
if __name__ == "__main__":
    import argparse
    parser = argparse.ArgumentParser(description="File Extension Tampering Validator")
    parser.add_argument("path", help="Path to file or directory to validate")
    args = parser.parse_args()

    if os.path.isdir(args.path):
        validate_directory(args.path)
    else:
        validate_file(args.path)





from safetensors.torch import save_file, load_file
import torch

# 1. Create some example tensors
tensors = {
    "weights": torch.randn(2, 2),
    "bias": torch.tensor([0.5, -0.5])
}

# 2. Add some metadata
metadata = {
    "created_by": "Pradyoth",
    "purpose": "Test safetensors metadata",
    "version": "1.0"
}

# 3. Save the safetensors file with metadata
save_file(tensors, "with_metadata.safetensors", metadata=metadata)

print("âœ… File 'with_metadata.safetensors' saved with metadata.")
